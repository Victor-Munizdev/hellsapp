<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Admin - Rastreamento em Tempo Real</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #fff;
      color: #222;
    }
    h1 {
      text-align: center;
      margin-bottom: 10px;
      color: #007bff;
    }
    #map {
      height: 70vh;
      width: 100%;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    #info, #debug {
      margin-top: 8px;
      font-size: 0.9em;
      color: #555;
      text-align: center;
      max-height: 150px;
      overflow-y: auto;
      white-space: pre-wrap;
      background: #e7f0ff;
      border-radius: 6px;
      padding: 10px;
    }
  </style>
</head>
<body>
  <h1>Admin - Rastreamento em Tempo Real</h1>
  <div id="map"></div>
  <div id="info">
    <p id="ultima-atualizacao">√öltima atualiza√ß√£o: --</p>
  </div>
  <div id="debug" aria-live="polite" aria-atomic="true"></div>

  <script>
    let map;
    const marcadores = {};
    const trilhaPorMotorista = {};
    const linhasPorMotorista = {};
    let socket;
    const debug = document.getElementById('debug');

    function logDebug(msg) {
      const timestamp = new Date().toLocaleTimeString();
      debug.textContent += `[${timestamp}] ${msg}\n`;
      debug.scrollTop = debug.scrollHeight;
    }

    function atualizarUltimaAtualizacao() {
      const agora = new Date();
      document.getElementById("ultima-atualizacao").textContent = "√öltima atualiza√ß√£o: " + agora.toLocaleTimeString();
    }

    function calcularDistanciaTotal(coords) {
      let total = 0;
      for (let i = 1; i < coords.length; i++) {
        const a = coords[i - 1], b = coords[i];
        total += google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(a.lat, a.lng),
          new google.maps.LatLng(b.lat, b.lng)
        );
      }
      return total;
    }

    function atualizarMotorista(data) {
      const id = data.motorista_id;
      const pos = { lat: parseFloat(data.latitude), lng: parseFloat(data.longitude) };
      logDebug(`Atualizando motorista ${id} para lat:${pos.lat}, lng:${pos.lng}`);

      if (!marcadores[id]) {
        marcadores[id] = new google.maps.Marker({
          position: pos,
          map: map,
          label: `${id}`,
          title: `Motorista ${id}`
        });
        logDebug(`Criado marcador para motorista ${id}`);
      } else {
        marcadores[id].setPosition(pos);
        logDebug(`Atualizado marcador para motorista ${id}`);
      }

      trilhaPorMotorista[id] = trilhaPorMotorista[id] || [];
      trilhaPorMotorista[id].push(pos);

      if (linhasPorMotorista[id]) {
        linhasPorMotorista[id].setPath(trilhaPorMotorista[id]);
      } else {
        linhasPorMotorista[id] = new google.maps.Polyline({
          path: trilhaPorMotorista[id],
          geodesic: true,
          strokeColor: "#007bff",
          strokeOpacity: 0.6,
          strokeWeight: 3,
          map: map
        });
        logDebug(`Criada linha para motorista ${id}`);
      }

      const distancia = calcularDistanciaTotal(trilhaPorMotorista[id]);
      logDebug(`Dist√¢ncia percorrida motorista ${id}: ${distancia.toFixed(1)} m`);

      atualizarUltimaAtualizacao();

      map.setCenter(pos);
    }

    function conectarWebSocket() {
      const wsUrl = "wss://hellsapp.onrender.com";

      socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        logDebug("üü¢ WebSocket conectado");
      };

      socket.onclose = () => {
        logDebug("WebSocket desconectado, tentando reconectar em 3 segundos...");
        setTimeout(conectarWebSocket, 3000);
      };

      socket.onerror = (err) => {
        logDebug("Erro no WebSocket: " + err.message || err);
        socket.close();
      };

      socket.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          logDebug("Mensagem recebida: " + JSON.stringify(data));
          if (data.tipo === "localizacao") {
            atualizarMotorista(data);
          }
        } catch (e) {
          logDebug("Erro ao processar mensagem: " + e.message);
        }
      };
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 15,
        center: { lat: -15.793889, lng: -47.882778 }
      });
      conectarWebSocket();
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAPJ2SemdkoFRMJYDF_gJbE8OWKVLYuFzI&libraries=geometry&callback=initMap">
  </script>
</body>
</html>
